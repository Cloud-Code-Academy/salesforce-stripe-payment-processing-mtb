@startuml Middleware System Architecture - With Scheduled Trigger
skinparam dpi 300
scale 0.4
title Stripe-Salesforce Middleware - Enhanced Architecture with CloudWatch Scheduled Events

skinparam linetype ortho
skinparam nodesep 150
skinparam ranksep 120
skinparam packagePadding 20
skinparam minClassWidth 150
skinparam componentSpacing 50

!define LIGHTBLUE #ADD8E6
!define LIGHTGREEN #90EE90
!define LIGHTORANGE #FFD580
!define LIGHTYELLOW #FFFACD
!define LIGHTPURPLE #E6E6FA
!define LIGHTRED #FFB6C1
!define LIGHTCYAN #B0E0E6

' === STRIPE (TOP LEFT) ===
package "Stripe" LIGHTBLUE {
    component [Webhook\nEvents] as stripe
}

' === AWS API GATEWAY ===
package "AWS API Gateway" LIGHTORANGE {
    component [HTTP API\n/webhook/stripe] as apigw
}

' === AWS CLOUDWATCH EVENTS (NEW) ===
package "AWS CloudWatch Events" LIGHTCYAN {
    component [Scheduled Rule\n(Every 1 minute)] as scheduler
}

' === LAMBDA 1: WEBHOOK RECEIVER ===
package "Lambda 1: Webhook Receiver" LIGHTGREEN {
    component [FastAPI App] as fastapi
    component [Signature\nVerification] as verify
    component [Event\nRouter] as router
}

' === AWS SQS QUEUES ===
package "AWS SQS" LIGHTYELLOW {
    queue "Main Event Queue\n(HIGH/MEDIUM)" as main_queue #lightgreen
    queue "Low-Priority Queue\n(LOW - Bulk API)" as low_queue #lightblue
    queue "Dead Letter Queue\n(Failed Events)" as dlq #lightcoral
}

' === LAMBDA 2: SQS WORKER ===
package "Lambda 2: SQS Worker" LIGHTGREEN {
    component [Event\nProcessor] as processor
    component [Payment\nHandler] as payment_handler
    component [Customer\nHandler] as customer_handler
    component [Subscription\nHandler] as subscription_handler
    component [REST API\nClient] as rest_client
}

' === LAMBDA 3: BULK PROCESSOR (ENHANCED) ===
package "Lambda 3: Bulk Processor" LIGHTPURPLE {
    component [Batch\nAccumulator] as batch
    component [CSV\nTransformer] as csv
    component [Bulk API\nClient] as bulk_client
    component [Proactive Batch\nProcessor] as proactive
}

' === AWS DYNAMODB ===
package "AWS DynamoDB" LIGHTORANGE {
    database "Cache Table\n(OAuth Tokens)" as dynamodb_cache
    database "Idempotency\nTracking" as dynamodb_idem
    database "Rate Limit\nCounters" as dynamodb_rate
    database "Batch Accumulator\n(Events)" as dynamodb_batch
}

' === SALESFORCE (BOTTOM) ===
package "Salesforce" LIGHTBLUE {
    component [REST API v63.0\n(Real-time)] as sf_rest
    component [Bulk API 2.0\n(Batch)] as sf_bulk

    database "Stripe_Customer__c" as customer_obj
    database "Contact" as contact_obj
    database "Stripe_Subscription__c" as subscription_obj
    database "Payment_Transaction__c" as payment_obj
}

' === AWS SECRETS MANAGER ===
cloud "AWS Secrets Manager" as secrets {
    storage "Stripe API Key" as secret_stripe
    storage "Salesforce OAuth" as secret_sf
}

' ============================================
' FLOW 1: WEBHOOK INGESTION
' ============================================

stripe -right-> apigw : **1.** POST webhook\n(payment_intent.succeeded,\ncustomer.updated, etc.)

apigw -down-> fastapi : **2.** Lambda invocation

fastapi -down-> verify : **3.** Verify HMAC-SHA256\nsignature

verify -down-> router : **4.** Route by priority

' ============================================
' FLOW 2A: HIGH/MEDIUM PRIORITY (REST API)
' ============================================

router -right-> main_queue : **5a.** HIGH/MEDIUM\npayment_intent.succeeded,\ninvoice.payment_failed,\nsubscription events
note right on link
  Priority: HIGH or MEDIUM
  Route to REST API
end note

main_queue -down-> processor : **6.** Poll (batch of 5)\nwith long polling

processor -down-> payment_handler : **7a.** Payment events
processor -down-> customer_handler : **7b.** Customer events
processor -down-> subscription_handler : **7c.** Subscription events

payment_handler -down-> rest_client : **8.** Process event
customer_handler -down-> rest_client : **8.** Process event
subscription_handler -down-> rest_client : **8.** Process event

rest_client -down-> sf_rest : **9.** REST API Call\n(Upsert with\nexternal ID)

' ============================================
' FLOW 2B: LOW PRIORITY (BULK API)
' ============================================

router -left-> low_queue : **5b.** LOW\ncustomer.updated\n(metadata changes)
note left on link
  Priority: LOW
  Route to Bulk API
end note

low_queue -down-> batch : **10.** Poll (batch of 10)\nwait up to 30s

batch -down-> csv : **11.** Transform to CSV

csv -down-> bulk_client : **12.** Submit bulk job

bulk_client -down-> sf_bulk : **13.** Bulk API 2.0\n(Upsert job)

' ============================================
' FLOW 3: SCHEDULED BATCH PROCESSING (NEW)
' ============================================

scheduler -down-> proactive : **14.** Triggered every\n1 minute\n(EventBridge)
note right on link
  Ensures batches are processed\n  within 1 minute of becoming ready
  even when SQS queue is empty
end note

proactive -down-> batch : **15.** Check for ready\nbatches in DynamoDB

batch -down-> csv : **16.** Transform ready\nbatches to CSV

csv -down-> bulk_client : **17.** Submit to Bulk API\nif batch is ready

' ============================================
' SALESFORCE DATA FLOW
' ============================================

sf_rest -down-> customer_obj : Create/Update
sf_rest -down-> contact_obj : Create/Update
sf_rest -down-> subscription_obj : Create/Update
sf_rest -down-> payment_obj : Create/Update

sf_bulk -down-> customer_obj : Batch Update
sf_bulk -down-> contact_obj : Batch Update (Contact via Stripe ID)

' ============================================
' SUPPORTING CONNECTIONS
' ============================================

' DynamoDB connections
router .right.> dynamodb_idem : Check duplicate\nevents (7-day TTL)
rest_client .left.> dynamodb_cache : OAuth token cache
rest_client .left.> dynamodb_rate : Rate limit check\n(10/sec, 250/min, 15k/day)
bulk_client .right.> dynamodb_cache : OAuth token cache
batch .right.> dynamodb_batch : Store accumulated\nevents
proactive .right.> dynamodb_batch : Query ready\nbatches

' Secrets Manager
fastapi .up.> secrets : Webhook secret
rest_client .up.> secrets : SF credentials
bulk_client .up.> secrets : SF credentials

' Dead Letter Queue
main_queue -[#red]down-> dlq : Failed after\n5 retries
low_queue -[#red]down-> dlq : Failed after\n3 retries

' ============================================
' LEGEND
' ============================================

legend right
  |<#lightgreen>| **Lambda Functions** |
  |<#lightyellow>| **SQS Queues** |
  |<#lightorange>| **AWS Services** |
  |<#lightblue>| **Salesforce** |
  |<#E6E6FA>| **Bulk Processor** |
  |<#B0E0E6>| **CloudWatch Events** |

  **Event Priorities:**
  • **HIGH**: payment/invoice failures, cancellations
  • **MEDIUM**: successful payments, subscriptions
  • **LOW**: customer metadata updates

  **Processing Methods:**
  • **REST API**: Real-time (< 5s for HIGH, < 30s for MEDIUM)
  • **Bulk API 2.0**: Batched (< 60s accumulation + processing)

  **Scheduled Trigger (NEW):**
  • **Every 1 minute**: CloudWatch Events invokes bulk processor
  • **Proactive Check**: process_ready_batches() checks DynamoDB
  • **Guaranteed Processing**: Batches process within 1 min of ready state
  • **SQS + Scheduled**: Dual triggers ensure no batch sits idle

  **Contact Updates (NEW):**
  • Both Stripe_Customer__c and Contact updated via Bulk API
  • Contact linked by Stripe_Customer_ID__c external ID
  • FirstName/LastName parsed from customer name field

  **Benefits:**
  • 90% reduction in API calls for customer updates
  • Critical events never blocked by batch processing
  • Automatic retry with DLQ for failures
  • Idempotency prevents duplicate processing
  • Batches never sit idle waiting for next event
end legend

@enduml
